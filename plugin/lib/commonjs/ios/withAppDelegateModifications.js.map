{"version":3,"names":["_configPlugins","require","_Paths","_ios","_codeInjection","_fileManagement","_utils","addImport","stringContents","appName","importRegex","addedImport","getImportSnippet","match","endOfMatchIndex","index","undefined","length","injectCodeByLineNumber","addNotificationHandlerDeclaration","injectCodeByMultiLineRegex","CIO_APPDELEGATEDECLARATION_REGEX","CIO_PUSHNOTIFICATIONHANDLERDECLARATION_SNIPPET","addNotificationConfiguration","injectCodeBeforeMultiLineRegex","CIO_DIDFINISHLAUNCHINGMETHOD_REGEX","CIO_CONFIGURECIOSDKPUSHNOTIFICATION_SNIPPET","addInitializeNativeCioSdk","CIO_INITIALIZECIOSDK_SNIPPET","addHandleDeeplinkInKilledStateConfiguration","regex","CIO_CONFIGUREDEEPLINK_KILLEDSTATE_SNIPPET","addDidFailToRegisterForRemoteNotificationsWithError","injectCodeByMultiLineRegexAndReplaceLine","CIO_DIDFAILTOREGISTERFORREMOTENOTIFICATIONSWITHERROR_REGEX","CIO_DIDFAILTOREGISTERFORREMOTENOTIFICATIONSWITHERROR_SNIPPET","addDidRegisterForRemoteNotificationsWithDeviceToken","CIO_DIDREGISTERFORREMOTENOTIFICATIONSWITHDEVICETOKEN_REGEX","CIO_DIDREGISTERFORREMOTENOTIFICATIONSWITHDEVICETOKEN_SNIPPET","addExpoNotificationsHeaderModification","addFirebaseDelegateForwardDeclarationIfNeeded","addAppdelegateHeaderModification","replace","CIO_APPDELEGATEHEADER_REGEX","interfaceDeclaration","_groupedDelegates","existingDelegates","includes","CIO_APPDELEGATEHEADER_USER_NOTIFICATION_CENTER_SNIPPET","CIO_APPDELEGATEHEADER_IMPORT_SNIPPET","trim","addHandleDeeplinkInKilledState","matchRegexExists","CIO_DEEPLINK_COMMENT_REGEX","snippet","CIO_LAUNCHOPTIONS_DEEPLINK_MODIFIEDOPTIONS_REGEX","CIO_RCTBRIDGE_DEEPLINK_MODIFIEDOPTIONS_REGEX","CIO_RCTBRIDGE_DEEPLINK_MODIFIEDOPTIONS_SNIPPET","CIO_LAUNCHOPTIONS_MODIFIEDOPTIONS_SNIPPET","replaceCodeByRegex","withAppDelegateModifications","configOuter","props","withAppDelegate","config","modResults","contents","RegExp","modRequest","projectName","_props$pushNotificati","_props$pushNotificati2","headerPath","getAppDelegateHeaderFilePath","projectRoot","headerContent","FileManagement","read","write","pushNotification","disableNotificationRegistration","handleDeeplinkInKilledState","isFcmPushProvider","console","log","exports"],"sources":["withAppDelegateModifications.js"],"sourcesContent":["import { withAppDelegate } from '@expo/config-plugins';\nimport { getAppDelegateHeaderFilePath } from '@expo/config-plugins/build/ios/Paths';\nimport { CIO_APPDELEGATEDECLARATION_REGEX, CIO_APPDELEGATEHEADER_IMPORT_SNIPPET, CIO_APPDELEGATEHEADER_REGEX, CIO_APPDELEGATEHEADER_USER_NOTIFICATION_CENTER_SNIPPET, CIO_CONFIGURECIOSDKPUSHNOTIFICATION_SNIPPET, CIO_CONFIGUREDEEPLINK_KILLEDSTATE_SNIPPET, CIO_RCTBRIDGE_DEEPLINK_MODIFIEDOPTIONS_REGEX, CIO_DIDFAILTOREGISTERFORREMOTENOTIFICATIONSWITHERROR_REGEX, CIO_DIDFAILTOREGISTERFORREMOTENOTIFICATIONSWITHERROR_SNIPPET, CIO_DIDFINISHLAUNCHINGMETHOD_REGEX, CIO_DIDREGISTERFORREMOTENOTIFICATIONSWITHDEVICETOKEN_REGEX, CIO_DIDREGISTERFORREMOTENOTIFICATIONSWITHDEVICETOKEN_SNIPPET, CIO_LAUNCHOPTIONS_DEEPLINK_MODIFIEDOPTIONS_REGEX, CIO_PUSHNOTIFICATIONHANDLERDECLARATION_SNIPPET, CIO_LAUNCHOPTIONS_MODIFIEDOPTIONS_SNIPPET, CIO_RCTBRIDGE_DEEPLINK_MODIFIEDOPTIONS_SNIPPET, CIO_DEEPLINK_COMMENT_REGEX, CIO_INITIALIZECIOSDK_SNIPPET, } from '../helpers/constants/ios';\nimport { injectCodeBeforeMultiLineRegex, injectCodeByLineNumber, injectCodeByMultiLineRegex, injectCodeByMultiLineRegexAndReplaceLine, replaceCodeByRegex, matchRegexExists, } from '../helpers/utils/codeInjection';\nimport { FileManagement } from '../helpers/utils/fileManagement';\nimport { isFcmPushProvider } from './utils';\nconst addImport = (stringContents, appName) => {\n    const importRegex = /^(#import .*)\\n/gm;\n    const addedImport = getImportSnippet(appName);\n    const match = stringContents.match(importRegex);\n    let endOfMatchIndex;\n    if (!match || match.index === undefined) {\n        // No imports found, just add to start of file:\n        endOfMatchIndex = 0;\n    }\n    else {\n        // Add after first import:\n        endOfMatchIndex = match.index + match[0].length;\n    }\n    stringContents = injectCodeByLineNumber(stringContents, endOfMatchIndex, addedImport);\n    return stringContents;\n};\nconst addNotificationHandlerDeclaration = (stringContents) => {\n    stringContents = injectCodeByMultiLineRegex(stringContents, CIO_APPDELEGATEDECLARATION_REGEX, CIO_PUSHNOTIFICATIONHANDLERDECLARATION_SNIPPET);\n    return stringContents;\n};\nconst addNotificationConfiguration = (stringContents) => {\n    stringContents = injectCodeBeforeMultiLineRegex(stringContents, CIO_DIDFINISHLAUNCHINGMETHOD_REGEX, CIO_CONFIGURECIOSDKPUSHNOTIFICATION_SNIPPET);\n    return stringContents;\n};\nconst addInitializeNativeCioSdk = (stringContents) => {\n    stringContents = injectCodeBeforeMultiLineRegex(stringContents, CIO_DIDFINISHLAUNCHINGMETHOD_REGEX, CIO_INITIALIZECIOSDK_SNIPPET);\n    return stringContents;\n};\nconst addHandleDeeplinkInKilledStateConfiguration = (stringContents, regex) => {\n    stringContents = injectCodeBeforeMultiLineRegex(stringContents, regex, CIO_CONFIGUREDEEPLINK_KILLEDSTATE_SNIPPET);\n    return stringContents;\n};\nconst addDidFailToRegisterForRemoteNotificationsWithError = (stringContents) => {\n    stringContents = injectCodeByMultiLineRegexAndReplaceLine(stringContents, CIO_DIDFAILTOREGISTERFORREMOTENOTIFICATIONSWITHERROR_REGEX, CIO_DIDFAILTOREGISTERFORREMOTENOTIFICATIONSWITHERROR_SNIPPET);\n    return stringContents;\n};\nconst addDidRegisterForRemoteNotificationsWithDeviceToken = (stringContents) => {\n    stringContents = injectCodeByMultiLineRegexAndReplaceLine(stringContents, CIO_DIDREGISTERFORREMOTENOTIFICATIONSWITHDEVICETOKEN_REGEX, CIO_DIDREGISTERFORREMOTENOTIFICATIONSWITHDEVICETOKEN_SNIPPET);\n    return stringContents;\n};\n// Adds required import for Expo Notifications package in AppDelegate.\n// Required to call functions from the package.\nconst addExpoNotificationsHeaderModification = (stringContents) => {\n    stringContents = injectCodeByLineNumber(stringContents, 0, `\n#if __has_include(<EXNotifications/EXNotificationCenterDelegate.h>)\n#import <EXNotifications/EXNotificationCenterDelegate.h>\n#endif\n`);\n    return stringContents;\n};\nconst addFirebaseDelegateForwardDeclarationIfNeeded = (stringContents) => {\n    stringContents = injectCodeByLineNumber(stringContents, 0, '@protocol FIRMessagingDelegate;');\n    return stringContents;\n};\nconst addAppdelegateHeaderModification = (stringContents) => {\n    // Add UNUserNotificationCenterDelegate if needed\n    stringContents = stringContents.replace(CIO_APPDELEGATEHEADER_REGEX, (match, interfaceDeclaration, _groupedDelegates, existingDelegates) => {\n        if (existingDelegates &&\n            existingDelegates.includes(CIO_APPDELEGATEHEADER_USER_NOTIFICATION_CENTER_SNIPPET)) {\n            // The AppDelegate declaration already includes UNUserNotificationCenterDelegate, so we don't need to modify it\n            return match;\n        }\n        else if (existingDelegates) {\n            // Other delegates exist, append ours\n            return `${CIO_APPDELEGATEHEADER_IMPORT_SNIPPET}\n${interfaceDeclaration}<${existingDelegates}, ${CIO_APPDELEGATEHEADER_USER_NOTIFICATION_CENTER_SNIPPET}>\n`;\n        }\n        else {\n            // No delegates exist, add ours\n            return `${CIO_APPDELEGATEHEADER_IMPORT_SNIPPET}\n${interfaceDeclaration.trim()} <${CIO_APPDELEGATEHEADER_USER_NOTIFICATION_CENTER_SNIPPET}>\n`;\n        }\n    });\n    return stringContents;\n};\nconst addHandleDeeplinkInKilledState = (stringContents) => {\n    // Find if the deep link code snippet is already present\n    if (matchRegexExists(stringContents, CIO_DEEPLINK_COMMENT_REGEX)) {\n        return stringContents;\n    }\n    // Check if the app delegate is using RCTBridge or LaunchOptions\n    let snippet = undefined;\n    let regex = CIO_LAUNCHOPTIONS_DEEPLINK_MODIFIEDOPTIONS_REGEX;\n    if (matchRegexExists(stringContents, CIO_RCTBRIDGE_DEEPLINK_MODIFIEDOPTIONS_REGEX)) {\n        snippet = CIO_RCTBRIDGE_DEEPLINK_MODIFIEDOPTIONS_SNIPPET;\n        regex = CIO_RCTBRIDGE_DEEPLINK_MODIFIEDOPTIONS_REGEX;\n    }\n    else if (matchRegexExists(stringContents, CIO_LAUNCHOPTIONS_DEEPLINK_MODIFIEDOPTIONS_REGEX)) {\n        snippet = CIO_LAUNCHOPTIONS_MODIFIEDOPTIONS_SNIPPET;\n    }\n    // Add code only if the app delegate is using RCTBridge or LaunchOptions\n    if (snippet !== undefined) {\n        stringContents = addHandleDeeplinkInKilledStateConfiguration(stringContents, regex);\n        stringContents = replaceCodeByRegex(stringContents, regex, snippet);\n    }\n    return stringContents;\n};\nexport const withAppDelegateModifications = (configOuter, props) => {\n    return withAppDelegate(configOuter, async (config) => {\n        let stringContents = config.modResults.contents;\n        const regex = new RegExp(`#import <${config.modRequest.projectName}-Swift.h>`);\n        const match = stringContents.match(regex);\n        if (!match) {\n            const headerPath = getAppDelegateHeaderFilePath(config.modRequest.projectRoot);\n            let headerContent = await FileManagement.read(headerPath);\n            headerContent = addAppdelegateHeaderModification(headerContent);\n            FileManagement.write(headerPath, headerContent);\n            stringContents = addImport(stringContents, config.modRequest.projectName);\n            stringContents = addNotificationHandlerDeclaration(stringContents);\n            // unless this property is explicity set to true, push notification\n            // registration will be added to the AppDelegate\n            if (props.pushNotification?.disableNotificationRegistration !== true) {\n                stringContents = addNotificationConfiguration(stringContents);\n            }\n            stringContents = addInitializeNativeCioSdk(stringContents);\n            if (props.pushNotification?.handleDeeplinkInKilledState === true) {\n                stringContents = addHandleDeeplinkInKilledState(stringContents);\n            }\n            stringContents =\n                addDidFailToRegisterForRemoteNotificationsWithError(stringContents);\n            stringContents =\n                addDidRegisterForRemoteNotificationsWithDeviceToken(stringContents);\n            if (isFcmPushProvider(props)) {\n                stringContents = addFirebaseDelegateForwardDeclarationIfNeeded(stringContents);\n            }\n            stringContents = addExpoNotificationsHeaderModification(stringContents);\n            config.modResults.contents = stringContents;\n        }\n        else {\n            console.log('Customerio AppDelegate changes already exist. Skipping...');\n        }\n        return config;\n    });\n};\nfunction getImportSnippet(appName) {\n    return `\n// Add swift bridge imports\n#import <ExpoModulesCore-Swift.h>\n#import <${appName}-Swift.h>\n  `;\n}\n"],"mappings":"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","ignoreList":[]}